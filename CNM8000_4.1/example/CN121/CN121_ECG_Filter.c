
#include "CN121_ECG_Filter.h"


#define COMB_NOTCH_50Hz_ORDER 10
#define LP_FIR_ORDER 56

#define NOTCH_50Hz_FILT_CAS_NUM 3
#define NOTCH_100Hz_FILT_CAS_NUM 2
#define NOTCH_150Hz_FILT_CAS_NUM 1
#define NOTCH_200Hz_FILT_CAS_NUM 1

uint16_t comb_notch_50Hz_cur_pnt = 0;
double comb_notch_50Hz_state[COMB_NOTCH_50Hz_ORDER+1] = {0};
uint16_t lp_fir_cur_pnt = 0;
float lp_fir_state[LP_FIR_ORDER+1] = {0};

float notch_50Hz_iir_state[6*NOTCH_50Hz_FILT_CAS_NUM] = {0};

static const double comb_notch_50Hz_coeff_a = 0.9191606776937863987342325344798155128955841064453125;
static const double comb_notch_50Hz_coeff_b = 0.95958033884689319936711626723990775644779205322265625;

static const float notch_50Hz_iir_coeffs[5*NOTCH_50Hz_FILT_CAS_NUM] = {
1.00000000000000000000000000000000e+00f,-1.62123310565948486328125000000000e+00f,1.00000000000000000000000000000000e+00f,1.50178730487823486328125000000000e+00f,-9.34754729270935058593750000000000e-01f,
1.00000000000000000000000000000000e+00f,-1.62123310565948486328125000000000e+00f,1.00000000000000000000000000000000e+00f,1.63304293155670166015625000000000e+00f,-9.43624854087829589843750000000000e-01f,
1.00000000000000000000000000000000e+00f,-1.62123310565948486328125000000000e+00f,1.00000000000000000000000000000000e+00f,1.52527117729187011718750000000000e+00f,-8.81618618965148925781250000000000e-01f
};
static const float notch_50Hz_iir_scale[NOTCH_50Hz_FILT_CAS_NUM] = {
9.68152225017547607421875000000000e-01f,9.68152225017547607421875000000000e-01f,9.40809309482574462890625000000000e-01f
};



static float lp_fir_coeffs[LP_FIR_ORDER+1] = {
		6.9941563286387696974505390201670707028824836015701293945312500000e-04f,
		9.7345595841664663352976738508459675358608365058898925781250000000e-04f,
		7.6565252761391850485489518618464899191167205572128295898437500000e-04f,
		-9.8806868460174327124136913347847422580267065221089469936877058842e-19f,
		-1.1377504922740386793245104257721322937868535518646240234375000000e-03f,
		-2.0748845071561494712852891098009422421455383300781250000000000000e-03f,
		-2.0068501669838379082577706213896817644126713275909423828125000000e-03f,
		-4.0715964512419791383052158906252770975697785615921020507812500000e-04f,
		2.3641038877174089076482754734342961455695331096649169921875000000e-03f,
		4.8497629165739847625915537321361625799909234046936035156250000000e-03f,
		5.0730444764004829424908216140011063544079661369323730468750000000e-03f,
		1.8036172177632195465918352184075956756714731454849243164062500000e-03f,
		-4.1864480069867034822683748984673002269119024276733398437500000000e-03f,
		-9.8401032114667393024820540858854656107723712921142578125000000000e-03f,
		-1.1088034611729408532299068212978454539552330970764160156250000000e-02f,
		-5.3214763915608665270640109667965589324012398719787597656250000000e-03f,
		6.2605869203251444943258974262789706699550151824951171875000000000e-03f,
		1.8082451141855190174245748835346603300422430038452148437500000000e-02f,
		2.2346966844517087563692925300529168453067541122436523437500000000e-02f,
		1.3345310591401808586464738937138463370501995086669921875000000000e-02f,
		-8.1657234404711471348337070708112150896340608596801757812500000000e-03f,
		-3.3157943718316769399212518010244821198284626007080078125000000000e-02f,
		-4.6792956306990818315938440719037316739559173583984375000000000000e-02f,
		-3.4715077416379594432704891460161888971924781799316406250000000000e-02f,
		9.5012499135420439011490145730931544676423072814941406250000000000e-03f,
		7.9492134152951962611233227562479441985487937927246093750000000000e-02f,
		1.5671030410836955804043668649683240801095962524414062500000000000e-01f,
		2.1685460278924673094280706209247000515460968017578125000000000000e-01f,
		2.3954349767176250085576327819580910727381706237792968750000000000e-01f,
		2.1685460278924673094280706209247000515460968017578125000000000000e-01f,
		1.5671030410836955804043668649683240801095962524414062500000000000e-01f,
		7.9492134152951962611233227562479441985487937927246093750000000000e-02f,
		9.5012499135420439011490145730931544676423072814941406250000000000e-03f,
		-3.4715077416379594432704891460161888971924781799316406250000000000e-02f,
		-4.6792956306990818315938440719037316739559173583984375000000000000e-02f,
		-3.3157943718316769399212518010244821198284626007080078125000000000e-02f,
		-8.1657234404711471348337070708112150896340608596801757812500000000e-03f,
		1.3345310591401808586464738937138463370501995086669921875000000000e-02f,
		2.2346966844517087563692925300529168453067541122436523437500000000e-02f,
		1.8082451141855190174245748835346603300422430038452148437500000000e-02f,
		6.2605869203251444943258974262789706699550151824951171875000000000e-03f,
		-5.3214763915608665270640109667965589324012398719787597656250000000e-03f,
		-1.1088034611729408532299068212978454539552330970764160156250000000e-02f,
		-9.8401032114667393024820540858854656107723712921142578125000000000e-03f,
		-4.1864480069867034822683748984673002269119024276733398437500000000e-03f,
		1.8036172177632195465918352184075956756714731454849243164062500000e-03f,
		5.0730444764004829424908216140011063544079661369323730468750000000e-03f,
		4.8497629165739847625915537321361625799909234046936035156250000000e-03f,
		2.3641038877174089076482754734342961455695331096649169921875000000e-03f,
		-4.0715964512419791383052158906252770975697785615921020507812500000e-04f,
		-2.0068501669838379082577706213896817644126713275909423828125000000e-03f,
		-2.0748845071561494712852891098009422421455383300781250000000000000e-03f,
		-1.1377504922740386793245104257721322937868535518646240234375000000e-03f,
		-9.8806868460174327124136913347847422580267065221089469936877058842e-19f,
		7.6565252761391850485489518618464899191167205572128295898437500000e-04f,
		9.7345595841664663352976738508459675358608365058898925781250000000e-04f,
		6.9941563286387696974505390201670707028824836015701293945312500000e-04f};

static float lp_fir_coeffs_Use_For_Standard[LP_FIR_ORDER + 1] =
			{
					2.2641800706599282352361746095681382939801551401615142822265625000e-04f,
					-7.5379257100575297080580217112810714752413332462310791015625000000e-04f,
					-1.0150596604143443182910466759949486004188656806945800781250000000e-03f,
					1.4865379626795622683366102438473873928895447215947937455449157085e-18f,
					1.5083665065705768523751650889153097523376345634460449218750000000e-03f,
					1.6066803163166960138896754983761638868600130081176757812500000000e-03f,
					-6.4966665590240814821126891231983790930826216936111450195312500000e-04f,
					-3.2006235783667994279633184362410247558727860450744628906250000000e-03f,
					-2.3711780578133606969815083687080914387479424476623535156250000000e-03f,
					2.3856385657537717767673335345079976832494139671325683593750000000e-03f,
					6.0144691156212570781747217552037909626960754394531250000000000000e-03f,
					2.6778031121500287144165941555229437653906643390655517578125000000e-03f,
					-5.9665270714168664595300484165818488691002130508422851562500000000e-03f,
					-9.8695480105051528602055910255330672953277826309204101562500000000e-03f,
					-1.5404686027437547793383920691212551901116967201232910156250000000e-03f,
					1.2241823654641038193746638285119843203574419021606445312500000000e-02f,
					1.4402206345350800770210852874697593506425619125366210937500000000e-02f,
					-2.5122079088037265262589592396125226514413952827453613281250000000e-03f,
					-2.2413836259777743936671967617257905658334493637084960937500000000e-02f,
					-1.9019741027997916216207840989227406680583953857421875000000000000e-02f,
					1.2123525671909277795501580499148985836654901504516601562500000000e-02f,
					3.9311192590376298205967486865120008587837219238281250000000000000e-02f,
					2.3017842952712364024137059459462761878967285156250000000000000000e-02f,
					-3.4818956253436714187721179314394248649477958679199218750000000000e-02f,
					-7.4687962968338073022067646888899616897106170654296875000000000000e-02f,
					-2.5733554908740657873877921701932791620492935180664062500000000000e-02f,
					1.2134813292331983469729550506599480286240577697753906250000000000e-01f,
					2.8749380629947646204058742114284541457891464233398437500000000000e-01f,
					3.6039043494799771760739304227172397077083587646484375000000000000e-01f,
					2.8749380629947646204058742114284541457891464233398437500000000000e-01f,
					1.2134813292331983469729550506599480286240577697753906250000000000e-01f,
					-2.5733554908740657873877921701932791620492935180664062500000000000e-02f,
					-7.4687962968338073022067646888899616897106170654296875000000000000e-02f,
					-3.4818956253436714187721179314394248649477958679199218750000000000e-02f,
					2.3017842952712364024137059459462761878967285156250000000000000000e-02f,
					3.9311192590376298205967486865120008587837219238281250000000000000e-02f,
					1.2123525671909277795501580499148985836654901504516601562500000000e-02f,
					-1.9019741027997916216207840989227406680583953857421875000000000000e-02f,
					-2.2413836259777743936671967617257905658334493637084960937500000000e-02f,
					-2.5122079088037265262589592396125226514413952827453613281250000000e-03f,
					1.4402206345350800770210852874697593506425619125366210937500000000e-02f,
					1.2241823654641038193746638285119843203574419021606445312500000000e-02f,
					-1.5404686027437547793383920691212551901116967201232910156250000000e-03f,
					-9.8695480105051528602055910255330672953277826309204101562500000000e-03f,
					-5.9665270714168664595300484165818488691002130508422851562500000000e-03f,
					2.6778031121500287144165941555229437653906643390655517578125000000e-03f,
					6.0144691156212570781747217552037909626960754394531250000000000000e-03f,
					2.3856385657537717767673335345079976832494139671325683593750000000e-03f,
					-2.3711780578133606969815083687080914387479424476623535156250000000e-03f,
					-3.2006235783667994279633184362410247558727860450744628906250000000e-03f,
					-6.4966665590240814821126891231983790930826216936111450195312500000e-04f,
					1.6066803163166960138896754983761638868600130081176757812500000000e-03f,
					1.5083665065705768523751650889153097523376345634460449218750000000e-03f,
					1.4865379626795622683366102438473873928895447215947937455449157085e-18f,
					-1.0150596604143443182910466759949486004188656806945800781250000000e-03f,
					-7.5379257100575297080580217112810714752413332462310791015625000000e-04f,
					2.2641800706599282352361746095681382939801551401615142822265625000e-04f };


float lp_fir_filter(float x)
{
	uint16_t i = 0;
	double y = 0;
	int16_t lp_40Hz_fir_delay_pnt = lp_fir_cur_pnt;
	lp_fir_state[lp_fir_cur_pnt] = x;

	while(i <= LP_FIR_ORDER)
	{
		y = y + lp_fir_state[lp_40Hz_fir_delay_pnt]*lp_fir_coeffs[i];
		lp_40Hz_fir_delay_pnt--;
		if(lp_40Hz_fir_delay_pnt < 0)
		{
			lp_40Hz_fir_delay_pnt = lp_40Hz_fir_delay_pnt + LP_FIR_ORDER + 1;
		}
		i++;
	}

	lp_fir_cur_pnt++;
	if(lp_fir_cur_pnt > LP_FIR_ORDER)
	{
		lp_fir_cur_pnt = 0;
	}

	return (float)y;
}

float comb_notch_50Hz_filter(float x)
{
	int16_t comb_notch_50Hz_delay_pnt = comb_notch_50Hz_cur_pnt - COMB_NOTCH_50Hz_ORDER;
	if(comb_notch_50Hz_delay_pnt < 0)
	{
		comb_notch_50Hz_delay_pnt = comb_notch_50Hz_delay_pnt + (COMB_NOTCH_50Hz_ORDER+1);
	}
	comb_notch_50Hz_state[comb_notch_50Hz_cur_pnt] = comb_notch_50Hz_coeff_a*comb_notch_50Hz_state[comb_notch_50Hz_delay_pnt] + comb_notch_50Hz_coeff_b*(double)x;

	float y = (float)(comb_notch_50Hz_state[comb_notch_50Hz_cur_pnt] - comb_notch_50Hz_state[comb_notch_50Hz_delay_pnt]);

	comb_notch_50Hz_cur_pnt++;
	if(comb_notch_50Hz_cur_pnt > COMB_NOTCH_50Hz_ORDER)
	{
		comb_notch_50Hz_cur_pnt = 0;
	}
	return y;
}

float biquad_df1_filter(float x, uint16_t cas_num, const float iir_coeffs[], const float iir_scale[], float iir_state[])
{
	uint16_t i = 0;
	float output = x;

	while(i < cas_num)
	{
		float input = output;
		float scale_input = input * notch_50Hz_iir_scale[i];
		iir_state[6*i+0] = scale_input;
		iir_state[6*i+3] = iir_coeffs[5*i+0]*iir_state[6*i+0] + iir_coeffs[5*i+1]*iir_state[6*i+1] + iir_coeffs[5*i+2]*iir_state[6*i+2] + iir_coeffs[5*i+3]*iir_state[6*i+4] + iir_coeffs[5*i+4]*iir_state[6*i+5];
		output = iir_state[6*i+3];

		iir_state[6*i+2] = iir_state[6*i+1];
		iir_state[6*i+1] = iir_state[6*i+0];
		iir_state[6*i+5] = iir_state[6*i+4];
		iir_state[6*i+4] = iir_state[6*i+3];

		i++;
	}

	return output;
}

float notch_50Hz_filter(float x)
{
	return biquad_df1_filter(x, NOTCH_50Hz_FILT_CAS_NUM, notch_50Hz_iir_coeffs, notch_50Hz_iir_scale, notch_50Hz_iir_state);
}

/**************************************************************
 * *******************Baseline removal*************************
 * ************************************************************/

#define N 1

#if N == 4

// 四阶IIR滤波器系数 0.67Hz高通
double a[5] =
		{
				1.0000000000000000000000000000000000000000000000000000000000000000e+00f,
				-3.9559979903331266015698020055424422025680541992187500000000000000e+00f,
				5.8689594755733480724302353337407112121582031250000000000000000000e+00f,
				-3.8699126166439268281749264133395627140998840332031250000000000000e+00f,
				9.5695121006201311342209692156757228076457977294921875000000000000e-01f };
double b[5] =
		{
				9.7823883078827578163583211789955385029315948486328125000000000000e-01f,
				-3.9129553231531031265433284715982154011726379394531250000000000000e+00f,
				5.8694329847296549118595976324286311864852905273437500000000000000e+00f,
				-3.9129553231531031265433284715982154011726379394531250000000000000e+00f,
				9.7823883078827578163583211789955385029315948486328125000000000000e-01f };
// 四阶IIR滤波器系数 5Hz 低通
double a_lp[5] =
		{
				1.0000000000000000000000000000000000000000000000000000000000000000e+00f,
				-3.8029975416543835287086494645336642861366271972656250000000000000e+00f,
				5.4281659636838943683301295095589011907577514648437500000000000000e+00f,
				-3.4462642180932077096144894312601536512374877929687500000000000000e+00f,
				8.2112513689245469894473217209451831877231597900390625000000000000e-01f };
double b_lp[5] =
		{
				1.8338017973509983599080148952698010589301702566444873809814453125e-06f,
				7.3352071894039934396320595810792042357206810265779495239257812500e-06f,
				1.1002810784105990159448089371618806353581021539866924285888671875e-05f,
				7.3352071894039934396320595810792042357206810265779495239257812500e-06f,
				1.8338017973509983599080148952698010589301702566444873809814453125e-06f };

//直接高通滤波,去除基线漂移
double iir_filt_hp(double input) {
	static double input_buff[N] = { 0 };
	static double output_buff[N] = { 0 };
	static int index = 0;

	int i, p;
	double output = b[0] * input;
	for (i = 1; i <= N; i++) {
		p = (index + N - i) % N;
		output += b[i] * input_buff[p] - a[i] * output_buff[p];
	}

	input_buff[index] = input;
	output_buff[index] = output;
	index = (index + 1) % N;
	return output;
}

//低通滤波,提取基线
double iir_filt_lp(double input) {
	static double input_buff[N] = { 0 };
	static double output_buff[N] = { 0 };
	static int index = 0;

	int i, p;
	double output = b_lp[0] * input;
	for (i = 1; i <= N; i++) {
		p = (index + N - i) % N;
		output += b_lp[i] * input_buff[p] - a_lp[i] * output_buff[p];
	}

	input_buff[index] = input;
	output_buff[index] = output;
	index = (index + 1) % N;
	return output;
}

#endif

#if N == 1
//0.67hz
double a[2] = { 1.00000000000000000000000000000000e+00f,
		-9.83301263282594151249327296682168e-01f };
double b[2] = { 9.91650631641297075624663648341084e-01f,
		-9.91650631641297075624663648341084e-01f };
//0.05hz
//double a[2] = { 1.00000000000000000000000000000000e+00f,
//		-9.98744151845968097802597185363993e-01f};
//double b[2] = {9.99372075922984048901298592681997e-01f,
//		-9.99372075922984048901298592681997e-01f};

double iir_filt_hp(double input) {
	static double input_buff = 0;
	static double output_buff = 0;

	double output = b[0] * input + b[1] * input_buff - a[1] * output_buff;
	input_buff = input;
	output_buff = output;
	return output;
}

#endif





#define MF_BUFFSIZE 5
#define WEIGHT_M    (1-1)

float median_filter(float x)
{
    static float x_buffer[MF_BUFFSIZE] = {0};
    static float y = 0;
    static int in_index = 0;
	


    x_buffer[in_index] = x;

    int middle_index = ((in_index + MF_BUFFSIZE) - MF_BUFFSIZE / 2) % MF_BUFFSIZE;

    in_index++;
    in_index %= MF_BUFFSIZE;

    float sum_temp = 0;
    for (int i = 0; i < MF_BUFFSIZE; i++)
    {
        sum_temp += x_buffer[i];
    }

    sum_temp += x_buffer[middle_index] * (WEIGHT_M);

    y = sum_temp / (MF_BUFFSIZE + WEIGHT_M);

    
    return y;
}



float CN121_ecg_filter(float ecg, uint8_t standard_signal, uint8_t init)
{
//  if(init == 1) {
//    if(standard_signal == 1) {
//      uint16_t i = 0;
//      for (i = 0; i < LP_FIR_ORDER + 1; i++) {
//        lp_fir_coeffs[i] = lp_fir_coeffs_Use_For_Standard[i];
//      }
//    }
//    return 0;
//  }
	float ecg_clean = ecg;
//  ecg_clean = comb_notch_50Hz_filter(ecg_clean);//h 是否去工频
//	ecg_clean = iir_filt_hp(ecg_clean);
//	
  ecg_clean =  lp_fir_filter(ecg_clean);
//  ecg_clean =  median_filter(ecg_clean);
				
	return ecg_clean;
}





